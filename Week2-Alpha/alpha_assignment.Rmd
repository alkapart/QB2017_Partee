---
title: 'Assignment: Local (alpha) Diversity'
author: 'Alison Partee; Z620: Quantitative Biodiversity, Indiana University'
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
geometry: margin=2.54cm
---

## OVERVIEW

In this exercise, we will explore aspects of local or site-specific diversity, also known as alpha ($\alpha$) diversity. 
First we will quantify two of the fundamental components of ($\alpha$) diversity: **richness** and **evenness**.
From there, we will then discuss ways to integrate richness and evenness, which will include univariate metrics of diversity along with an investigation of the **species abundance distribution (SAD)**.

## Directions:
1. Change "Student Name" on line 3 (above) with your name.
2. Complete as much of the exercise as possible during class; what you do not complete in class will need to be done on your own outside of class.
3. Use the handout as a guide; it contains a more complete description of data sets along with the proper scripting needed to carry out the exercise.
4. Be sure to **answer the questions** in this exercise document; they also correspond to the handout.
Space for your answer is provided in this document and indicated by the ">" character.
If you need a second paragraph be sure to start the first line with ">".
5. Before you leave the classroom, **push** this file to your GitHub repo.
6. For homework, follow the directions at the bottom of this file. 
7. When you are done, **Knit** the text and code into a PDF file.
8. After Knitting, please submit the completed exercise by creating a **pull request** via GitHub.
Your pull request should include this file `alpha_assignment.Rmd` and the PDF output of `Knitr` (`alpha_assignment.pdf`).


## 1) R SETUP

In the R code chunk below, please provide the code to: 
1) Clear your R environment,
2) Print your current working directory,
3) Set your working directory to your `/Week2-Alpha` folder, and
4) Load the `vegan` R package (be sure to install if needed).

```{r}
rm(list=ls())
getwd()
setwd("/Users/flopsei/GitHub/QB2017_Partee/Week2-Alpha/")

#install.packages("vegan")
require("vegan")



```

## 2) LOADING DATA

In the R code chunk below, do the following:
1) Load your dataset, and 
2) Display the structure of the dataset (if the structure is long, use `max.level=0` to show just basic information).

```{r}
#load dataset
data(BCI)

#display the structure of the dataset
str(BCI, max.level = 0)

```

## 3) SPECIES RICHNESS

**Species richness (S)** is simply the number of species in a system or the number of species observed in a sample.

### Observed Richness

In the R code chunk below, do the following:

1. Write a function called `S.obs` to calculate observed richness

2. Use your function to determine the number of species in `site1`, and

3. Compare the output of your function to the output of the `specnumber()` function in vegan.

```{r}

#write a function to calculate observed richness
S.obs <- function(x = ""){
  # input: site by species matrix
  # output: vector of named nums
  # purpose: sums the amount of cells > 0 for each row
  rowSums(x > 0)
}

S.obs(BCI)

site1 <- BCI[1,]

#determine the number of species in site1
speccount1 <- S.obs(BCI)[[1]]

#output of the specnumber() function in vegan
vspeccount1 <- specnumber(BCI)[[1]]


```

***Question 1***: Does `specnumber()` from `vegan` return the same value for observed richness in `site1` as our function `S.obs`?
What is the species richness of the first 4 sites (i.e., rows) of the BCI matrix?

> ***Answer 1***: 
> Yes, they both returned the same value for observed richness. 
> Species richness for site 1: 93
> Species richness for site 2: 84
> Species richness for site 3: 90
> Species richness for site 4: 94



### Coverage. How Well Did You Sample Your Site?

In the R code chunk below, do the following:

1. Write a function to calculate Good's Coverage, and

2. Use that function to calculate coverage for all sites in the BCI matrix.

```{r}

#write a function for Good's Coverage
C <- function(x = ""){
  #input: site by species matrix
  #output: vector of Good's Coverage per site
  1 - (rowSums(x == 1) / rowSums(x))
}

#use the function to calculate coverage for all sites
sitecoverage <- C(BCI)

```
  
***Question 2***: Answer the following questions about coverage:

a.  What is the range of values that can be generated by Good's Coverage? 
b.  What would we conclude from Good's Coverage if $n_{i}$ equaled *N*?
c.  What portion of taxa in `site1` were represented by singletons? 
d.  Make some observations about coverage at the BCI plots.

> ***Answer 2a***:  Good's coverage values range from 0 to 1

> ***Answer 2b***:  Only 1 individual was recorded per species

> ***Answer 2c***:  .069

> ***Answer 2d***:  The sites in the BCI data have relatively low proportions of singleton species.


### Estimated Richness

In the R code chunk below, do the following:

1. Load the microbial dataset (located in the `/Week2-Alpha/data` folder),

2. Transform and transpose the data as needed (see handout),

3. Create a vector (`soilbac1`) with the bacterial OTU abundances at any site in the dataset,

4. Calculate the observed richness at that particular site, and 

5. Calculate the coverage at that particular site

```{r}

#load the microbial data set
soilbac <- read.table("data/soilbac.txt", sep = "\t", header = TRUE, row.names = 1)

#transform and transpose like the handout
soilbac.t <- as.data.frame(t(soilbac))

#create vector soilbac1 with the OTU abundances at site 1
soilbac1 <- soilbac.t[1,]

#observed richness for site 1
obsrichness1 <- S.obs(soilbac1)

#coverage for site 1
cov1 <- C(soilbac1)



```

***Question 3***: Answer the following questions about the soil bacterial dataset. 

a.  How many sequences did we recover from the sample `soilbac1`, i.e. *N*? 
b.  What is the observed richness of `soilbac1`? 
c.  How does coverage compare between the BCI sample (`site1`) and the KBS sample (`soilbac1`)?

> ***Answer 3a***:  1074

> ***Answer 3b***: .648

> ***Answer 3c***: The coverage of soilbac1 was lower than the coverage from the BCI sample, site1. 


### Richness Estimators

In the R code chunk below, do the following:

1. Write a function to calculate **Chao1**,

2. Write a function to calculate **Chao2**, 

3. Write a function to calculate **ACE**, and

4. Use these functions to estimate richness at both `site1` and `soilbac1`. 

```{r}

#write a function to calculate chao1
S.chao1 <- function(x = "") {
  #input: x is a vector of incidence counts at a site
  twicecount <- sum(x == 2)
  if ( twicecount == 0 ) {
    chao1 <- S.obs(x);
  } else {
    chao1 <- S.obs(x) + (sum(x == 1)^2)/(2*twicecount);
  }
  return(chao1)
}


#write a function to calculate chao2
S.chao2 <- function(site = "", SbyS = ""){
  SbyS = as.data.frame(SbyS)
  x = SbyS[site,]
  SbyS.pa <- (SbyS > 0) * 1 #convert the SbyS to presence/absence
  Q1 = sum(colSums(SbyS.pa) == 1) #species observed once
  Q2 = sum(colSums(SbyS.pa) == 2) #species observed twice
  if (Q2 == 0) {
    Q2 <- 1;
  }
  S.chao2 = S.obs(x) + (Q1^2)/(2*Q2)
  return(S.chao2)
}

#write a function to calculate ACE
S.ace <- function(x = "", thresh = 10) {
  x <- x[x>0] #excludes zero-abundance taxa
  S.abund <- length(which(x > thresh)) #richness of abundant data
  S.rare <- length(which(x <= thresh)) #richness of rare taxa
  singlt <- length(which(x == 1)) #number of singleton taxa
  N.rare <- sum(x[which(x <= thresh)]) #abundance of rare individuals
  C.ace <- 1 - (singlt / N.rare) #coverage (prop non-singlt rare inds)
  i <- c(1:thresh) #threshhold abundance range
  count <- function(i, y){ #counter to go through i range
    length(y[y == i])
  }
  a.1 <- sapply(i, count, x) #number of individuals in richness i richness classes
  f.1 <- (i * (i - 1)) * a.1 #k(k-1)kf sensu Gotelli
  G.ace <- (S.rare/C.ace)*(sum(f.1)/(N.rare*(N.rare - 1)))
  S.ace <- S.abund + (S.rare/C.ace) + (singlt/C.ace) * max(G.ace, 0)
  return(S.ace)
}

#chao1 est richness for soilbac1
S.chao1(soilbac1)

#chao1 est richness for site1
S.chao1(site1)

#chao2 est richness for soilbac1
S.chao2(1,soilbac.t)

#chao2 est richness for site1
S.chao2(1,BCI)

#ace est richness for soilbac1
S.ace(soilbac1)

#ace est richness for site1
S.ace(site1)



```

### Rarefaction

In the R code chunk below, please do the following:

1. Calculate observed richness for all samples in `soilbac`,

2. Determine the size of the smallest sample,

3. Use the `rarefy()` function to rarefy each sample to this level,

4. Plot the rarefaction results, and

5. Add the 1:1 line and label.


```{r}

#calculate obs richness in soilbac data
soilbac.S <- S.obs(soilbac.t)

#determine the size of the smallest sample
min.N <- min(rowSums(soilbac.t))

#use the rerefy() function to rarefy each sample to the level of the min
S.rarefy <- rarefy(x = soilbac.t, sample = min.N, se = TRUE)

#plot the rarefraction results
rarecurve(x = soilbac.t, step = 20, col = "blue", cex = 0.6, las=1)
abline(0,1,col = 'red')
text(1500, 1500, "1:1", pos = 2, col = 'red')





```

***Question 4***: What is the difference between ACE and the Chao estimators?

> ***Answer 4***: The Chao estimators only take into account singleton and doubleton species, while the ACE estimator takes into account all rare species under a given threshold.


##4) SPECIES EVENNESS
Here, we consider how abundance varies among species, that is, **species evenness**.

### Visualizing Evenness: The Rank Abundance Curve (RAC)
One of the most common ways to visualize evenness is in a **rank-abundance curve** (sometime referred to as a rank-abundance distribution or Whittaker plot).
An RAC can be constructed by ranking species from the most abundant to the least abundant without respect to species labels (and hence no worries about 'ties' in abundance). 

In the R code chunk below, do the following:

1. Write a function to construct a RAC,

2. Be sure your function removes species that have zero abundances, 

3. Order the vector (RAC) from greatest (most abundant) to least (least abundant), and 

4. Return the ranked vector

```{r}

#write a function to construct an RAC
RAC <- function(x = "") {
  x = as.vector(x)
  x.ab = x[x > 0]
  x.ab.ranked = x.ab[order(x.ab, decreasing = TRUE)]
  return(x.ab.ranked)
}





```

Now, let's examine the RAC for `site1` of the BCI data set.

In the R code chunk below, do the following:

1. Create a sequence of ranks and plot the RAC with natural-log-transformed abundances,

2. Label the x-axis "Rank in abundance" and the y-axis "log(abundance)"

```{r}

plot.new()
site1 <- BCI[1,]

rac <- RAC(x = site1)
ranks <- as.vector(seq(1,length(rac)))
opar <- par(no.readonly = TRUE) #saves default plot parameters
par(mar = c(5.1, 5.1, 4.1, 2.1)) #new settings for par
plot(ranks, log(rac), type = 'p', axes = F, #plot without axes
     xlab = "Rank in abundance", ylab = "Abundance", las = 1, cex.lab = 1.4, cex.axis = 1.25)
box() #manually adds border
axis(side = 1, labels = T, cex.axis = 1.25) #manually adds x axis
axis(side = 2, las = 1, cex.axis = 1.25, #manually adds log scaled y axis
     labels = c(1, 2, 5, 10, 20), at = log(c(1, 2, 5, 10, 20)))

par <- opar #resets plotting parameters

```

***Question 5***: What effect does visualizing species abundance data on a log-scaled axis have on how we interpret evenness in the RAC?

> ***Answer 5***: It leads us to interpret evenness based on the assumption that abundance decreased exponentially with rank. This allows us to visually see the data on a small plot, whereas if the axis wasn't log-scaled, we would not be able to see the data on the right half of the plot as easily.


Now that we have visualized unevennes, it is time to quantify it using Simpson's evenness ($E_{1/D}$) and Smith and Wilson's evenness index ($E_{var}$).

### Simpson's evenness ($E_{1/D}$)

In the R code chunk below, do the following:

1. Write the function to calculate $E_{1/D}$, and

2. Calculate $E_{1/D}$ for `site1`.

```{r}
#write a function to calculate simpson's evenness
SimpE <- function(x = "") {
  S <- S.obs(x)
  x = as.data.frame(x)
  D <- diversity(x, "inv")
  E <- (D)/S
  return(E)
}

#calculate simpson's evenness for site1
site1 <- BCI[1,]
SimpE(site1)




```

### Smith and Wilson's evenness index ($E_{var}$)

In the R code chunk below, please do the following:

1. Write the function to calculate $E_{var}$,

2. Calculate $E_{var}$ for `site1`, and

3. Compare $E_{1/D}$ and $E_{var}$.

```{r}

#write a function to calculate smith and wilson's evenness index
Evar <- function(x) {
  x <- as.vector(x[x > 0])
  1 - (2/pi)*atan(var(log(x)))
}

#calculate E_var for site1
Evar(site1)


```

***Question 6***: Compare estimates of evenness for `site1` of BCI using $E_{1/D}$ and $E_{var}$.
Do they agree? If so, why? If not, why? What can you infer from the results.

> ***Answer 6***: They are similar, but differ by about .08 . The two metrics of evenness gave different estimates because they calculate evenness in different ways. Simpson's Evenness is a simple measure useing the sample variance, and Smith and Wilson's Index is a more complex calculation that attempts to remove some biases.


##5) INTEGRATING RICHNESS AND EVENNESS: DIVERSITY METRICS

So far, we have introduced two primary aspects of diversity, i.e., richness and evenness.
Here, we will use popular indices to estimate diversity, which explicitly incorporate richness and evenness
We will write our own diversity functions and compare them against the functions in `vegan`. 

### Shannon's diversity (a.k.a., Shannon's entropy)

In the R code chunk below, please do the following:

1. Provide the code for calculating H' (Shannon's diversity),

2. Compare this estimate with the output of `vegan`'s diversity function using method = "shannon".

```{r}

#code for calculating H'
ShanH <- function(x = ""){
  H = 0
  for (n_i in x){
    if(n_i > 0) {
      p = n_i / sum(x)
      H = H - p*log(p)
    }
    }
  return(H)
}

#compare
diversity(site1, index = "shannon")
ShanH(site1)






```

### Simpson's diversity (or dominance)

In the R code chunk below, please do the following:

1. Provide the code for calculating D (Simpson's diversity),

2. Calculate both the inverse (1/D) and 1 - D,

2. Compare this estimate with the output of `vegan's` diversity function using method = "simp".

```{r}

#code for calculating Simpson's Diversity
SimpD <- function(x = ""){
  D = 0
  N = sum(x)
  for (n_i in x){
    D = D + (n_i^2)/(N^2)
    }
  return(D)
}

SimpD(site1)

#calculate 1/D and 1 - D
D.inv <- 1/SimpD(site1)
D.sub <- 1-SimpD(site1)

D.inv
D.sub

#compare
diversity(site1, "inv")
diversity(site1, "simp")





```

***Question 7***: Compare estimates of evenness for `site1` of BCI using $E_{H'}$ and $E_{var}$.
Do they agree? If so, why? If not, why? What can you infer from the results.

> ***Answer 7***: I don't think they're very comparable because Shannon's Diversity index values have a different range than Smith and Wilson's Evenness index.

### Fisher's $\boldsymbol\alpha$

In the R code chunk below, please do the following:

1. Provide the code for calculating Fisher's $\boldsymbol\alpha$,

2. Calculate Fisher's $\boldsymbol\alpha$ for `site1` of BCI.

```{r}

#code for calculating Fisher's alpha
rac <- as.vector(site1[site1 > 0])
invD <- diversity(rac, "inv")
invD

#calculate Fisher's alpha for site1 of BCI
Fisher <- fisher.alpha(rac)
Fisher


```

***Question 8***: How is Fisher's $\boldsymbol\alpha$ different from $E_{H'}$ and $E_{var}$? What does Fisher's $\boldsymbol\alpha$ take into account that $E_{H'}$ and $E_{var}$ do not?

> ***Answer 8***: Fisher's alpha takes into account sampling error, which neither Shannon's Diversity Index nor E_var take into account.

##6) MOVING BEYOND UNIVARIATE METRICS OF $\alpha$ DIVERSITY

The diversity metrics that we just learned about attempt to integrate richness and evenness into a single, univariate metric.
Although useful, information is invariably lost in this process. 
If we go back to the rank-abundance curve, we can retrieve additional information -- and in some cases -- make inferences about the processes influencing the structure of an ecological system.

## Species abundance models

The RAC is a simple data structure that is both a vector of abundances.
It is also a row in the site-by-species matrix (minus the zeros, i.e., absences). 

Predicting the form of the RAC is the first test that any biodiversity theory must pass and there are no less than 20 models that have attempted to explain the uneven form of the RAC across ecological systems.

In the R code chunk below, please do the following:

1. Use the `radfit()` function in the `vegan` package to fit the predictions of various species abundance models to the RAC of `site1` in BCI,

2. Display the results of the `radfit()` function, and 

3. Plot the results of the `radfit()` function using the code provided in the handout.

```{r}

RACresults <- radfit(site1)

RACresults

#plot the results
plot.new()
plot(RACresults, las = 1, cex.lab = 1.4, cex.axis = 1.25)

```


***Question 9***: Answer the following questions about the rank abundance curves:
a) Based on the output of `radfit()` and plotting above, discuss which model best fits our rank-abundance curve for `site1`?
b) Can we make any inferences about the forces, processes, and/or mechanisms influencing the structure of our system, e.g., an ecological community?

> ***Answer 9a***:  The 'Mandelbrot' model best fits our rank-abundance curve for site1.
> ***Answer 9b***: Yes, the Mandelbrot model is derived from the Zipf model, which predicts that the abundance of a species in the RAC is inversely proportional to its abundance rank. There is an added parameter in the Mandelbrot model that controls the evenness of the RAC. Our third parameter is positive, indicating a high evenness level for highly abundant species.


***Question 10***: Answer the following questions about the preemption model:
a.  What does the preemption model assume about the relationship between total abundance (*N*) and total resources that can be preempted?
b.  Why does the niche preemption model look like a straight line in the RAD plot?

> ***Answer 10a***: Each additional species added (eg, species N + 1) acquires only a fraction, alpha, of the resources acquired by the Nth species. This means the amount of food available to each added species exponentially decreases, limiting the total abundance value for a given amount of total resources.
> ***Answer 10b***: The niche preemption model looks like a straight line in the RAD plot because the y axis is log transformed, and the preemption model is an exponential function, causing the line to look straight.



***Question 11***: Why is it important to account for the number of parameters a model uses when judging how well it explains a given set of data?

> ***Answer 11***: Over-parameterizing a model can be bad. Data naturally has random variation in its values. Adding more parameters to better fit a model can incorporate those small variations into the model, while those additional parameters often add meaningless complexity to the model. Therefore, it is important to account for the number of parameters a model uses in order to compare models. Even though a model with more parameters will better fit data, it is not necessarily a better model.


## SYNTHESIS

1.  As stated by Magurran (2004) the  ${D = } \sum p_i^2$ derivation of Simpson's Diversity only applies to communities of infinite size. For anything but an infinitely large community, Simpson's Diversity index is calculated as ${D = } \sum \frac{n_i(n_i -1)} {N(N-1)}$. 
Assuming a finite community, calculate Simpson's D, 1 - D, and Simpson's inverse (i.e. 1/D) for `site 1` of the BCI site-by-species matrix. 


```{r}

#function for finding simpson's div with finite N
SimpD.finite <- function(x = "") {
  D = 0
  N = sum(x)
  for (n_i in x) {
    D = D + n_i*(n_i-1)/(N*(N-1))
  }
  return(D)
}

finitesimpD <- SimpD.finite(site1)
finitesimpD

finitesimpD.inv <- 1/finitesimpD
finitesimpD.inv

finitesimpD.sub <- 1-finitesimpD
finitesimpD.sub


```



2.  Along with the rank-abundance curve (RAC), another way to visualize the distribution of abundance among species is with a histogram (a.k.a., frequency distribution) that shows the frequency of different abundance classes.
For example, in a given sample, there may be 10 species represented by a single individual, 8 species with two individuals, 4 species with three individuals, and so on.
In fact, the rank-abundance curve and the frequency distribution are the two most common ways to visualize the species-abundance distribution (SAD) and to test species abundance models and biodiversity theories.
To address this homework question, use the R function **hist()** to plot the frequency distribution for `site 1` of the BCI site-by-species matrix, and describe the general pattern you see.


```{r}

#use hist() to plot the frequency distribution of site1
hist(as.numeric(site1), xlab = 'observed individuals', main = 'Frequency distribution of Site 1')

#without 0s
hist(as.numeric(site1)[site1 > 0], xlab = 'observed individuals', main = 'Frequency distribution of Site 1')

```

> ***Synthesis Q2 Answer***: The general pattern I see is that there are a large amount of species with few observed individuals, and a small amount of species that had a lot of observed individuals.

3.  We asked you to find a biodiversity dataset with your partner.
This data could be one of your own or it could be something that you obtained from the literature. 
Load that dataset.
How many sites are there?
How many species are there in the entire site-by-species matrix?
Any other interesting observations based on what you learned this week?


```{r}

#load the dataset
speciesdata <- read.table("/Users/flopsei/GitHub/QB2017_Partee/speciesdata_clean.csv", sep = ",", header = TRUE)

speciesdatanums <- speciesdata[,5:dim(speciesdata)[2]]

#number of sites
dim(speciesdatanums)[1]

#number of species
dim(speciesdatanums)[2]

```


## SUBMITTING YOUR ASSIGNMENT
Use Knitr to create a PDF of your completed alpha_assignment.Rmd document, push it to GitHub, and create a pull request.
Please make sure your updated repo include both the HTML and RMarkdown files.

Unless otherwise noted, this assignment is due on **Wednesday, January 25^th^, 2015 at 12:00 PM (noon)**.